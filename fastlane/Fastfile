# Fastfile for Flutter iOS CI/CD

org, repo = (ENV["GITHUB_REPOSITORY"] || "").split("/")
match_org, match_repo = (ENV["MATCH_REPOSITORY"] || "").split("/")

platform :ios do

  ############################################################
  # One-time CI bootstrap (создаёт deploy key и match repo)
  ############################################################
  lane :init_ci do
    github_action(
      api_token: ENV["GH_PAT"],
      org: org,
      repo: repo,
      match_org: match_org,
      match_repo: match_repo,
      writable_deploy_key: true
    )
  end

  ############################################################
  # BOOTSTRAP: создаёт сертификаты, если match-repo пустой
  # ❗ БЕЗ api_key (обход Apple bug)
  ############################################################
  desc "Create certificates if match repo is empty"
  lane :sync_certificates do
    # Авторизация fastlane (НЕ передаём api_key в match)
    app_store_connect_api_key(
      key_id: ENV["APPSTORE_KEY_ID"],
      issuer_id: ENV["APPSTORE_ISSUER_ID"],
      key_content: ENV["APPSTORE_P8"]
    )

    main_app_bundle_id = ENV["IOS_BUNDLE_ID"]
    extension_bundle_id = "#{main_app_bundle_id}.notifications"

    match(
      type: "appstore",
      storage_mode: "git",
      git_url: "git@github.com:#{match_org}/#{match_repo}.git",
      app_identifier: [main_app_bundle_id, extension_bundle_id],
      readonly: false
    )
  end

  ############################################################
  # CI / BUILD: только установка сертификатов (readonly)
  ############################################################
  desc "Sync certificates for CI build (readonly)"
  lane :sync_certificates_for_build do
    api_key = app_store_connect_api_key(
      key_id: ENV["APPSTORE_KEY_ID"],
      issuer_id: ENV["APPSTORE_ISSUER_ID"],
      key_content: ENV["APPSTORE_P8"]
    )

    main_app_bundle_id = ENV["IOS_BUNDLE_ID"]
    extension_bundle_id = "#{main_app_bundle_id}.notifications"

    match(
      type: "appstore",
      storage_mode: "git",
      git_url: "git@github.com:#{match_org}/#{match_repo}.git",
      app_identifier: [main_app_bundle_id, extension_bundle_id],
      readonly: true,
      skip_certificate_matching: true,
      api_key: api_key
    )
  end

  ############################################################
  # Build + TestFlight
  ############################################################
  desc "Build and upload to TestFlight"
  lane :beta do
    setup_ci

    # ❗ В CI всегда используем readonly-lane
    sync_certificates_for_build

    ##########################################################
    # Manual code signing
    ##########################################################
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "ios/Runner.xcodeproj",
      team_id: ENV["APPLE_TEAM_ID"],
      bundle_identifier: ENV["IOS_BUNDLE_ID"],
      profile_name: ENV["sigh_#{ENV['IOS_BUNDLE_ID']}_appstore_profile-name"],
      code_sign_identity: "Apple Distribution"
    )

    update_code_signing_settings(
      use_automatic_signing: false,
      path: "ios/Runner.xcodeproj",
      targets: "notifications",
      team_id: ENV["APPLE_TEAM_ID"],
      bundle_identifier: "#{ENV['IOS_BUNDLE_ID']}.notifications",
      profile_name: ENV["sigh_#{ENV['IOS_BUNDLE_ID']}.notifications_appstore_profile-name"],
      code_sign_identity: "Apple Distribution"
    )

    ##########################################################
    # ExportOptions.plist
    ##########################################################
    export_options_path = File.expand_path("../ios/ExportOptions.plist", __dir__)
    require "plist"

    export_options = Plist.parse_xml(export_options_path) || {
      "method" => "app-store",
      "teamID" => ENV["APPLE_TEAM_ID"],
      "provisioningProfiles" => {}
    }

    export_options["teamID"] = ENV["APPLE_TEAM_ID"]
    export_options["provisioningProfiles"] = {
      ENV["IOS_BUNDLE_ID"] =>
        ENV["sigh_#{ENV['IOS_BUNDLE_ID']}_appstore_profile-name"]
    }

    File.write(export_options_path, export_options.to_plist)

    ##########################################################
    # Safe build number
    ##########################################################
    safe_build_number =
      if ENV["FORCE_CI_BUILD_NUMBER"] == "true" &&
         ENV["BUILD_NUMBER"].to_i > 0
        ENV["BUILD_NUMBER"]
      else
        Time.now.to_i.to_s
      end

    ##########################################################
    # Update Info.plist
    ##########################################################
    info_plist_path = File.expand_path("../ios/Runner/Info.plist", __dir__)
    if File.exist?(info_plist_path)
      plist = Plist.parse_xml(info_plist_path)
      plist["CFBundleVersion"] = safe_build_number
      File.write(info_plist_path, plist.to_plist)
    end

    ##########################################################
    # Build Flutter IPA
    ##########################################################
    sh(
      "flutter build ipa --release " \
      "--export-options-plist=#{export_options_path} " \
      "--build-number=#{safe_build_number} " \
      "--no-tree-shake-icons"
    )

    ipa_path =
      Dir.glob(File.expand_path("../build/ios/ipa/*.ipa", __dir__)).first
    UI.user_error!("IPA not found") unless ipa_path

    ##########################################################
    # Upload to TestFlight
    ##########################################################
    upload_to_testflight(
      ipa: ipa_path,
      skip_waiting_for_build_processing: true,
      api_key: app_store_connect_api_key(
        key_id: ENV["APPSTORE_KEY_ID"],
        issuer_id: ENV["APPSTORE_ISSUER_ID"],
        key_content: ENV["APPSTORE_P8"]
      )
    )
  end
end
